using Application.Abstractions;
using Application.DTOs;
using Application.Services;
using Application.Common.Security;
using Domain.Entities;
using Domain.Enums;
using System.Security.Claims;
using FluentAssertions;
using Microsoft.AspNetCore.Http;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Moq;
using Infrastructure.Persistence;

namespace Application.UnitTests.Services;

public class WorkoutSessionServiceReopenTests : IDisposable
{
    private readonly AppDbContext _db;
    private readonly Mock<IHttpContextAccessor> _mockHttp;
    private readonly WorkoutSessionService _sut;
    private readonly Guid _userId = Guid.NewGuid();

    public WorkoutSessionServiceReopenTests()
    {
        var services = new ServiceCollection();
        services.AddDbContext<AppDbContext>(opt => opt.UseInMemoryDatabase(Guid.NewGuid().ToString()));
        var provider = services.BuildServiceProvider();
        _db = provider.GetRequiredService<AppDbContext>();

        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.NameIdentifier, _userId.ToString()),
            new Claim("sub", _userId.ToString())
        };
        var identity = new ClaimsIdentity(claims, "Test");
        var claimsPrincipal = new ClaimsPrincipal(identity);

        var httpContext = new DefaultHttpContext
        {
            User = claimsPrincipal
        };

        _mockHttp = new Mock<IHttpContextAccessor>();
        _mockHttp.Setup(x => x.HttpContext).Returns(httpContext);
        _sut = new WorkoutSessionService(_db, _mockHttp.Object);
    }

    public void Dispose()
    {
        _db.Database.EnsureDeleted();
        _db.Dispose();
    }

    [Fact]
    public async Task ReopenScheduledAsync_QuickCompleteSession_ShouldSucceed()
    {
        // Arrange
        var plan = new Plan { Id = Guid.NewGuid(), PlanName = "Test Plan", Type = "PPL", CreatedByUserId = _userId };
        var scheduled = new ScheduledWorkout 
        { 
            Id = Guid.NewGuid(), 
            PlanId = plan.Id,
            PlanName = "Test Plan",
            UserId = _userId,
            Date = DateOnly.FromDateTime(DateTime.Today),
            Status = ScheduledStatus.Completed
        };
        var session = new WorkoutSession
        {
            Id = Guid.NewGuid(),
            ScheduledId = scheduled.Id,
            UserId = _userId,
            Status = WorkoutSessionStatus.Completed,
            StartedAtUtc = DateTime.UtcNow.AddHours(-1),
            CompletedAtUtc = DateTime.UtcNow,
            IsQuickComplete = true
        };

        _db.Plans.Add(plan);
        _db.ScheduledWorkouts.Add(scheduled);
        _db.WorkoutSessions.Add(session);
        await _db.SaveChangesAsync();

        // Act
        var result = await _sut.ReopenScheduledAsync(scheduled.Id, CancellationToken.None);

        // Assert
        result.Should().BeTrue();
        _db.WorkoutSessions.Should().BeEmpty();
        var updatedScheduled = await _db.ScheduledWorkouts.FindAsync(scheduled.Id);
        updatedScheduled!.Status.Should().Be(ScheduledStatus.Planned);
    }

    [Fact]
    public async Task ReopenScheduledAsync_AbortedSession_ShouldSucceed()
    {
        // Arrange
        var plan = new Plan { Id = Guid.NewGuid(), PlanName = "Test Plan", Type = "PPL", CreatedByUserId = _userId };
        var scheduled = new ScheduledWorkout 
        { 
            Id = Guid.NewGuid(), 
            PlanId = plan.Id,
            PlanName = "Test Plan",
            UserId = _userId,
            Date = DateOnly.FromDateTime(DateTime.Today),
            Status = ScheduledStatus.Completed
        };
        var session = new WorkoutSession
        {
            Id = Guid.NewGuid(),
            ScheduledId = scheduled.Id,
            UserId = _userId,
            Status = WorkoutSessionStatus.Aborted,
            StartedAtUtc = DateTime.UtcNow.AddHours(-1),
            CompletedAtUtc = DateTime.UtcNow,
            IsQuickComplete = false
        };

        _db.Plans.Add(plan);
        _db.ScheduledWorkouts.Add(scheduled);
        _db.WorkoutSessions.Add(session);
        await _db.SaveChangesAsync();

        // Act
        var result = await _sut.ReopenScheduledAsync(scheduled.Id, CancellationToken.None);

        // Assert
        result.Should().BeTrue();
        _db.WorkoutSessions.Should().BeEmpty();
        var updatedScheduled = await _db.ScheduledWorkouts.FindAsync(scheduled.Id);
        updatedScheduled!.Status.Should().Be(ScheduledStatus.Planned);
    }

    [Fact]
    public async Task ReopenScheduledAsync_LiveWorkoutSession_ShouldThrowInvalidOperationException()
    {
        // Arrange
        var plan = new Plan { Id = Guid.NewGuid(), PlanName = "Test Plan", Type = "PPL", CreatedByUserId = _userId };
        var scheduled = new ScheduledWorkout 
        { 
            Id = Guid.NewGuid(), 
            PlanId = plan.Id,
            PlanName = "Test Plan",
            UserId = _userId,
            Date = DateOnly.FromDateTime(DateTime.Today),
            Status = ScheduledStatus.Completed
        };
        var session = new WorkoutSession
        {
            Id = Guid.NewGuid(),
            ScheduledId = scheduled.Id,
            UserId = _userId,
            Status = WorkoutSessionStatus.Completed,
            StartedAtUtc = DateTime.UtcNow.AddHours(-2),
            CompletedAtUtc = DateTime.UtcNow,
            IsQuickComplete = false
        };

        _db.Plans.Add(plan);
        _db.ScheduledWorkouts.Add(scheduled);
        _db.WorkoutSessions.Add(session);
        await _db.SaveChangesAsync();

        // Act
        var act = async () => await _sut.ReopenScheduledAsync(scheduled.Id, CancellationToken.None);

        // Assert
        await act.Should().ThrowAsync<InvalidOperationException>()
            .WithMessage("Cannot reopen this session*");
    }

    [Fact]
    public async Task ReopenScheduledAsync_ActiveSessionExists_ShouldThrowInvalidOperationException()
    {
        // Arrange
        var plan = new Plan { Id = Guid.NewGuid(), PlanName = "Test Plan", Type = "PPL", CreatedByUserId = _userId };
        var scheduled = new ScheduledWorkout 
        { 
            Id = Guid.NewGuid(), 
            PlanId = plan.Id,
            PlanName = "Test Plan",
            UserId = _userId,
            Date = DateOnly.FromDateTime(DateTime.Today),
            Status = ScheduledStatus.Completed
        };
        var quickCompleteSession = new WorkoutSession
        {
            Id = Guid.NewGuid(),
            ScheduledId = scheduled.Id,
            UserId = _userId,
            Status = WorkoutSessionStatus.Completed,
            StartedAtUtc = DateTime.UtcNow.AddHours(-2),
            CompletedAtUtc = DateTime.UtcNow,
            IsQuickComplete = true
        };
        var activeSession = new WorkoutSession
        {
            Id = Guid.NewGuid(),
            ScheduledId = scheduled.Id,
            UserId = _userId,
            Status = WorkoutSessionStatus.InProgress,
            StartedAtUtc = DateTime.UtcNow
        };

        _db.Plans.Add(plan);
        _db.ScheduledWorkouts.Add(scheduled);
        _db.WorkoutSessions.AddRange(quickCompleteSession, activeSession);
        await _db.SaveChangesAsync();

        // Act
        var act = async () => await _sut.ReopenScheduledAsync(scheduled.Id, CancellationToken.None);

        // Assert
        // Note: Method finds most recent session (active one), which is InProgress and can't be reopened
        await act.Should().ThrowAsync<InvalidOperationException>()
            .WithMessage("Cannot reopen this session*");
    }

    [Fact]
    public async Task ReopenScheduledAsync_NoSession_ShouldThrowInvalidOperationException()
    {
        // Arrange
        var plan = new Plan { Id = Guid.NewGuid(), PlanName = "Test Plan", Type = "PPL", CreatedByUserId = _userId };
        var scheduled = new ScheduledWorkout 
        { 
            Id = Guid.NewGuid(), 
            PlanId = plan.Id,
            PlanName = "Test Plan",
            UserId = _userId,
            Date = DateOnly.FromDateTime(DateTime.Today),
            Status = ScheduledStatus.Planned
        };

        _db.Plans.Add(plan);
        _db.ScheduledWorkouts.Add(scheduled);
        await _db.SaveChangesAsync();

        // Act
        var act = async () => await _sut.ReopenScheduledAsync(scheduled.Id, CancellationToken.None);

        // Assert
        await act.Should().ThrowAsync<InvalidOperationException>()
            .WithMessage("No session found*");
    }

    [Fact]
    public async Task ReopenScheduledAsync_ScheduledNotFound_ShouldThrowKeyNotFoundException()
    {
        // Arrange
        var nonExistentId = Guid.NewGuid();

        // Act
        var act = async () => await _sut.ReopenScheduledAsync(nonExistentId, CancellationToken.None);

        // Assert
        await act.Should().ThrowAsync<KeyNotFoundException>()
            .WithMessage("Scheduled workout not found");
    }
}
