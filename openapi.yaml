openapi: 3.0.3
info:
  title: FitMate Backend API
  version: "1.0.0"
  description: |
    Backend API for training plans, scheduled workouts, sessions and analytics with JWT authentication.
servers:
  - url: http://localhost:8080
tags:
  - name: Health
  - name: Auth
  - name: Plans
  - name: Scheduled
  - name: Sessions
  - name: Analytics
  - name: Users
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ProblemDetails:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string }

    SetDto:
      type: object
      required: [reps, weight]
      properties:
        reps: { type: integer, minimum: 0 }
        weight: { type: number, format: double, minimum: 0 }

    ExerciseDto:
      type: object
      required: [name, rest, sets]
      properties:
        name: { type: string }
        rest: { type: integer, description: "Rest time in seconds" }
        sets:
          type: array
          items: { $ref: "#/components/schemas/SetDto" }

    PlanRequest:
      type: object
      required: [planName, type, exercises]
      properties:
        planName: { type: string }
        type: { type: string, description: "e.g. FBW / Push-Pull-Legs / etc." }
        notes: { type: string, nullable: true }
        exercises:
          type: array
          items: { $ref: "#/components/schemas/ExerciseDto" }

    PlanResponse:
      allOf:
        - $ref: "#/components/schemas/PlanRequest"
        - type: object
          properties:
            id: { type: string, format: uuid }

    ScheduledStatus:
      type: string
      enum: [planned, completed]

    ScheduledRequest:
      type: object
      required: [date, planId, planName, exercises]
      properties:
        date: { type: string, format: date }
        time: { type: string, description: "HH:mm", nullable: true }
        planId: { type: string, format: uuid }
        planName: { type: string }
        notes: { type: string, nullable: true }
        exercises:
          type: array
          items: { $ref: "#/components/schemas/ExerciseDto" }
        status:
          $ref: "#/components/schemas/ScheduledStatus"
          default: planned

    ScheduledResponse:
      allOf:
        - $ref: "#/components/schemas/ScheduledRequest"
        - type: object
          properties:
            id: { type: string, format: uuid }

    SessionStartRequest:
      type: object
      required: [scheduledId]
      properties:
        scheduledId: { type: string, format: uuid }

    SessionSetUpdateRequest:
      type: object
      required: [exerciseOrder, setNumber]
      properties:
        exerciseOrder: { type: integer, minimum: 0 }
        setNumber: { type: integer, minimum: 1 }
        repsDone: { type: integer, minimum: 0, nullable: true }
        weightDone: { type: number, format: double, minimum: 0, nullable: true }
        rpe: { type: number, nullable: true }
        isFailure: { type: boolean, nullable: true }

    SessionResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        scheduledId: { type: string, format: uuid }
        status: { type: string, enum: [inProgress, completed, aborted] }
        startedAtUtc: { type: string, format: date-time, nullable: true }
        completedAtUtc: { type: string, format: date-time, nullable: true }
        notes: { type: string, nullable: true }

    OverviewDto:
      type: object
      properties:
        totalVolume: { type: number }
        avgIntensity: { type: number }
        sessionsCount: { type: integer }
        adherencePct: { type: number }
        newPrs: { type: integer }

    TimePointDto:
      type: object
      properties:
        period: { type: string }
        value: { type: number }
        exerciseName: { type: string, nullable: true }

    E1rmPointDto:
      type: object
      properties:
        day: { type: string, format: date }
        e1Rm: { type: number }
        sessionId: { type: string, format: uuid }

    AdherenceDto:
      type: object
      properties:
        planned: { type: integer }
        completed: { type: integer }
        missed: { type: integer }
        adherencePct: { type: number }

    PlanVsActualItemDto:
      type: object
      properties:
        exerciseName: { type: string }
        setNumber: { type: integer }
        repsPlanned: { type: integer, nullable: true }
        weightPlanned: { type: number, nullable: true }
        repsDone: { type: integer, nullable: true }
        weightDone: { type: number, nullable: true }
        rpe: { type: number, nullable: true }
        isFailure: { type: boolean, nullable: true }
        repsDiff: { type: number, nullable: true }
        weightDiff: { type: number, nullable: true }

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }
        fullName: { type: string, nullable: true }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }

    AuthResponse:
      type: object
      properties:
        accessToken: { type: string }
        expiresAtUtc: { type: string, format: date-time }

paths:
  /:
    get:
      tags: [Health]
      summary: Ping root
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  name: { type: string }

  /health/db:
    get:
      tags: [Health]
      summary: Database connectivity check
      responses:
        '200': { description: DB OK }
        '500': { description: DB not reachable }

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RegisterRequest" }
      responses:
        '200':
          description: Auth token issued
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthResponse" }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        '200':
          description: Auth token issued
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthResponse" }
        '400':
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }

  /api/plans:
    get:
      tags: [Plans]
      summary: Get all plans
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of plans
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/PlanResponse" }
    post:
      tags: [Plans]
      summary: Create plan
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PlanRequest" }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PlanResponse" }

  /api/plans/{id}:
    get:
      tags: [Plans]
      summary: Get plan by id
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: Single plan
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PlanResponse" }
        '404': { description: Not found }
    put:
      tags: [Plans]
      summary: Update plan
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PlanRequest" }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PlanResponse" }
    delete:
      tags: [Plans]
      summary: Delete plan
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '204': { description: No content }

  /api/plans/{id}/duplicate:
    post:
      tags: [Plans]
      summary: Duplicate plan
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '201':
          description: Duplicated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PlanResponse" }

  /api/scheduled:
    get:
      tags: [Scheduled]
      summary: Get all scheduled workouts
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of scheduled
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ScheduledResponse" }
    post:
      tags: [Scheduled]
      summary: Create scheduled workout
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ScheduledRequest" }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScheduledResponse" }

  /api/scheduled/{id}:
    get:
      tags: [Scheduled]
      summary: Get scheduled by id
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: Single scheduled
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScheduledResponse" }
        '404': { description: Not found }
    put:
      tags: [Scheduled]
      summary: Update scheduled workout
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ScheduledRequest" }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScheduledResponse" }
    delete:
      tags: [Scheduled]
      summary: Delete scheduled workout
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '204': { description: No content }

  /api/scheduled/{id}/duplicate:
    post:
      tags: [Scheduled]
      summary: Duplicate scheduled workout
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: string, format: uuid }
          required: true
      responses:
        '201':
          description: Duplicated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScheduledResponse" }

  /api/scheduled/by-date:
    get:
      tags: [Scheduled]
      summary: Get scheduled workouts by date
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
      responses:
        '200':
          description: List for the day
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ScheduledResponse" }

  /api/sessions/start:
    post:
      tags: [Sessions]
      summary: Start a session from scheduled workout
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SessionStartRequest" }
      responses:
        '200':
          description: Started
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }

  /api/sessions/{id}:
    get:
      tags: [Sessions]
      summary: Get session
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Session
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }
        '404': { description: Not found }

  /api/sessions/{id}/set:
    patch:
      tags: [Sessions]
      summary: Update a set during session
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SessionSetUpdateRequest" }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }

  /api/sessions/{id}/complete:
    post:
      tags: [Sessions]
      summary: Complete session
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Completed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }

  /api/sessions/{id}/abort:
    post:
      tags: [Sessions]
      summary: Abort session
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Aborted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SessionResponse" }

  /api/sessions/by-range:
    get:
      tags: [Sessions]
      summary: Sessions in date range
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: from
          required: true
          schema: { type: string, format: date-time }
        - in: query
          name: to
          required: true
          schema: { type: string, format: date-time }
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/SessionResponse" }

  /api/analytics/overview:
    get:
      tags: [Analytics]
      summary: KPI for given period
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: from
          required: true
          schema: { type: string, format: date }
        - in: query
          name: to
          required: true
          schema: { type: string, format: date }
      responses:
        '200':
          description: Overview
          content:
            application/json:
              schema: { $ref: "#/components/schemas/OverviewDto" }

  /api/analytics/volume:
    get:
      tags: [Analytics]
      summary: Volume over time or by exercise
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: from
          required: true
          schema: { type: string, format: date }
        - in: query
          name: to
          required: true
          schema: { type: string, format: date }
        - in: query
          name: groupBy
          required: true
          schema:
            type: string
            enum: [day, week, exercise]
        - in: query
          name: exerciseName
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Series
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/TimePointDto" }

  /api/analytics/exercises/{name}/e1rm:
    get:
      tags: [Analytics]
      summary: e1RM history for exercise
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: name
          required: true
          schema: { type: string }
        - in: query
          name: from
          required: true
          schema: { type: string, format: date }
        - in: query
          name: to
          required: true
          schema: { type: string, format: date }
      responses:
        '200':
          description: e1RM series
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/E1rmPointDto" }

  /api/analytics/adherence:
    get:
      tags: [Analytics]
      summary: Planned vs completed workouts
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: fromDate
          required: true
          schema: { type: string, format: date }
        - in: query
          name: toDate
          required: true
          schema: { type: string, format: date }
      responses:
        '200':
          description: Adherence
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AdherenceDto" }

  /api/analytics/plan-vs-actual:
    get:
      tags: [Analytics]
      summary: Compare planned vs actual sets in a session
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: sessionId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Differences list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/PlanVsActualItemDto" }

  /api/users:
    get:
      tags: [Users]
      summary: List users (Admin only)
      description: Requires role Admin.
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Users
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: string, format: uuid }
                    email: { type: string }
                    fullName: { type: string, nullable: true }
        '403': { description: Forbidden }

  /api/users/{id}/role:
    put:
      tags: [Users]
      summary: Assign role to user (Admin only)
      description: Requires role Admin.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: roleName
          required: true
          schema: { type: string }
      responses:
        '204': { description: No content }
        '400': { description: Bad request }
        '404': { description: Not found }
